# Rede
# Instalação e atualização de pacotes

Primeira coisa configurar os pacotes que ficam no repositório:

```
vim /etc/apt/sources.list
```
<<<<<<< HEAD
=======

```
teste
```
>>>>>>> e8a4debf32a1aa18a688f40e75b02bf4e7a7c89d

Atualizei os pacotes com o comando conhecido

```
apt-get update
```

Depois apt-get update para tualiar todos os pacotes. Comando demorado ...
'''
apt-get update
```
No /var/cache/apt/archives com o comando dpkg -c wget <tab> para ver os arquivos com referencia a documentacao e licença

O comando dpkg -s <nome-do-pacote> da informações do pacote.

```
dpkg -s wget
'''

O comando dpkg -l <nome-do-pacote> fornece informações da instalação e versão do pacote
```
dpkg -l tzdata
```

Ver o tamanho dos pacotes no /var

```
df -hT
```

Instalar um pacote

```
apt-get insta <nome-do-pacote>
```

Desinstalar ...

```
apt-get remove <nome-do-pacote>
```

E para remover até os arquivos de configuração do pacote ...

```
apt-get purge <nome-do-pacote>
```

# Configurando placa de rede

Configurar reduncia da placa de rede. Essa técnica é conhecida como link aggregation.

O Balanceamento de carga é chamado bouding.

## Gerando um par de chaves para acessar o servidor via ssh

Gerar um par de chaves para acessar o servidor via par de chaves é melhor que acessá-lo pela interface do Virtualbox. A opção  de um console para copiar e colocar as linhas de comandos é mais usual que a console padrão do virtualbox.

## gerar um ssh key pair

Comando:
```
ssh-keygen -t rsa
```
##Ver o ip do linux
```
ip a
```

## Configurando as interfaces de rede

```
ifconfig -a
```

As placas enp0s8 e enp0s9 não estão ativas



arquivo interface:

´´´
auto enp0s8
iface enp0s8 inet manual
           bond-master bond0
auto enp0s9
iface enp0s9 inet manual
           bond-master bond0
auto bond0
iface bond0 inet static
             address 10.10.10.1
             netmask 255.255.255.0
             bond-mode balance-rr = 0
             bond-miimon 100
             bond-slaves enp0s8 enp0s9
´´´

Permissão de executação
´´´
chmod +x <nome-do-arquivo>
´´´

Comandos iniciais na iptables. Listagem das regras.
Observar que a lista vem dividida por chain: INPUT, FORWARD e OUTPUT

´´´
iptable filter -nvL
´´´
## Criar uma unidade de serviço para o script firewall

Copiar uma unidade de serviço existente

´´´
cd /lib/systemd/system
ls -ltr
´´´
Criar uma copia do networking.services
´´´
cp -v networking.service firewall.service
´´´

Após editar o arquivo é necessário colocar ele pra rodar como daemon

Reiniciar o daemon

´´´
systemctl daemon-reload
´´´

Verificar o status do serviço
´´´
systemctl status firewall.service
´´´
Criar um link de execução do serviço
´´´
systemctl enable firewall.service
´´´
Listar os serviços que serão iniciados com o sistema.
Na lista de comandos deverá aparecer o firewall.service
´´´
ls -ltr /etc/systemd/system/multi-user.target.wants/
´´´

# Configuração do network aggregation desdo do inicio

## Vangrantfile final

´´´ 
# -*- mode: ruby -*-
# vi: set ft=ruby :
################################################################################
# Ubuntu Server
################################################################################

VAGRANTFILE_API_VERSION = '2'.freeze
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.synced_folder "D:/Arquivos/devops/cursos_ubuntu_server/ubuntuserver/share", "/home/vagrant/share", nfs:true
  config.vm.box = 'ubuntu/xenial64'

  config.vm.define :firewall01 do |firewall01_config|
    firewall01_config.vm.hostname = 'firewall'
    config.vm.network "private_network", virtualbox__intnet: "intnet"
    config.vm.network "private_network", virtualbox__intnet: "intnet"
      config.vm.provider "virtualbox" do |v|
        #v.memory = 3000
        #v.cpus = 1
        v.name = "firewall01"
      end
    end
end

´´´
## Arquivo /etc/network/interface
´´´
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

# The loopback network interface
auto lo
iface lo inet loopback

# Source interfaces
# Please check /etc/network/interfaces.d before changing this file
# as interfaces may have been defined in /etc/network/interfaces.d
# See LP: #1262951
source /etc/network/interfaces.d/*.cfg
#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.

auto enp0s3
iface enp0s3 inet dhcp

auto enp0s8
iface enp0s8 inet manual
        bond-master bond0

auto enp0s9
iface enp0s9 inet manual
        bond-master bond0

auto bond0
iface bond0 inet static
        address 10.10.10.1
        netmask 255.255.255.0
        bond-mode balance-rr = 0
        bond-miimon 100
        bond-slaves enp0s8 enp0s9
#VAGRANT-END

#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.
# auto enp0s9
# iface enp0s9 inet static
#      address
#      netmask 255.255.255.0
#VAGRANT-END

´´´
# Configurar o Iptables do servidor firewall

Listar o iptables default

´´´
iptables -t filter -nvL
´´´

Resultado:
´´´
vagrant@firewall:~$ sudo iptables -t filter -nvL
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

´´´

Executando comando ping para saber se o servidor de firewall tem ou não saída para internet
ping no dns de servidor do google
´´´
ping 8.8.8.8
´´´
Resultado:
´´´
64 bytes from 8.8.8.8: icmp_seq=1 ttl=118 time=165 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=118 time=233 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=118 time=12.1 ms
´´´
## Saída para internet

Após configurar o scrit firewall

ver o status antes de executar as configurações para saída intenert

´´´
sysctl net.ipv4.ip_forward
´´´
Reiniciar o serviço
´´´
systemctl restart firewall.service 
´´´

Ver o conteúdo da tabela nat
´´´
iptables -t nat -nvL
´´´